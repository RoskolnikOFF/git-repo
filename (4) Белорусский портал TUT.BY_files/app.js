var TUTBYPushManager=TUTBYPushManager||function(){function e(e,t){this.name=e,this.version=parseInt(t||1,10),this.table="app_store"}function t(){}function n(){}function o(e,t){return e?t?e.endpoint.replace(/^.*\/([^\/]+)$/,"$1"):e.endpoint:null}function i(e){var t=e.match(/^#check-(.+)$/);if(!t)return!1;try{return JSON.parse(d(t[1]))}catch(n){}return!1}function a(e){if(e)return e[0];var t;return(t=navigator.userAgent.match(/Firefox\/(\d+)\.\d+/))?parseInt(t[1],10)>43&&"serviceWorker"in navigator?"firefox":!1:(t=navigator.userAgent.match(/Version\/(\d+).* Safari/))&&!navigator.userAgent.match(/iP(?:hone|[ao]d)/)?parseInt(t[1],10)>7&&"safari"in window&&"pushNotification"in window.safari?"safari":!1:(t=navigator.userAgent.match(/Chrome\/(\d+)\./i))&&!navigator.userAgent.match(/(?:Edge|OPR\/| wv|iP(?:hone|[ao]d))/)&&parseInt(t[1],10)>41&&"serviceWorker"in navigator?"chrome":!1}function r(){function e(e){e=e||window.safari.pushNotification.permission(p.apn_id);var o=new n,i=e.deviceToken,a=e.permission;o.manageToken(a,i).then(function(){switch(p.log(a),t(a,i),a){case"granted":break;case"default":break;case"denied":}})["catch"](function(e){p.log("[AS] error",e)})}function t(e,t){switch(e){case"granted":$("#grantedSubscribe").prop("checked",!!t).prop("disabled",!0),$("html").attr("class","granted");break;case"default":p.autoRegister&&$("html.default").length<1?($("html").attr("class","default"),$("html.default #defaultSubscribe").trigger("click")):($("html").attr("class","default"),$("html.default #defaultSubscribe").show());break;case"denied":$("html").attr("class","denied")}}function o(){$("body").addClass("safari"),p.return_url&&-1===p.return_url.indexOf("https://www.tut.by/push/")&&($("form").each(function(){var e=$(this);e.attr("action",p.defaultUrl+p.scope+"redir"),$('<input type="hidden" name="url" value="'+p.return_url.replace(/"/g,"&quote;")+'" />').appendTo(e)}),$('input[type="submit"]').val("Вернуться")),$(document).on("click","html.default #defaultSubscribe",function(t){return window.safari.pushNotification.requestPermission(p.defaultUrl+p.scope.replace(/\/*$/g,""),p.apn_id,null,e),t.preventDefault(),!1}),p.autoRegister&&$("html.default #defaultSubscribe").trigger("click")}o(),e()}function s(){function e(){var e=document.createElement("link");e.rel="manifest",e.href=p.defaultUrl+p.scope+"manifest.json",document.head.appendChild(e)}function t(e){e.pushManager.getSubscription(p.scope).then(function(e){var t=new n,a=o(e,"chrome"==p.platform),r=Notification.permission;t.manageToken(r,a).then(function(){switch(i(r,a),r){case"granted":break;case"default":break;case"denied":}})["catch"](function(e){p.log("[AS] error",e)})})["catch"](function(e){p.log("[SW] Error getting subscription",e)})}function i(e,t){switch(e){case"granted":$("#grantedSubscribe").prop("checked",!!t),$("html").attr("class","granted");break;case"default":p.autoRegister&&$("html.default").length<1?($("html").attr("class","default"),$("html.default #defaultSubscribe").trigger("click")):($("html").attr("class","default"),$('html.default #defaultSubscribe,html.default div.default input[type="submit"]').show());break;case"denied":$("html").attr("class","denied")}}function a(e){$("body").addClass(p.platform),p.return_url&&-1===p.return_url.indexOf("https://www.tut.by/push/")&&($("form").each(function(){var e=$(this);e.attr("action",p.defaultUrl+p.scope+"redir"),$('<input type="hidden" name="url" value="'+p.return_url.replace(/"/g,"&quote;")+'" />').appendTo(e)}),$('input[type="submit"]').val("Вернуться")),$(document).on("click","html.default #defaultSubscribe",function(n){e.pushManager.subscribe({userVisibleOnly:!0}).then(function(){t(e)})["catch"](function(n){t(e)}),n.preventDefault()}),$(document).on("click","html.granted #grantedSubscribe",function(n){var o=$("html.granted #grantedSubscribe").prop("checked");o?e.pushManager.subscribe({userVisibleOnly:!0}).then(function(){t(e)})["catch"](function(n){t(e)}):e.pushManager.getSubscription(p.scope).then(function(n){n?n.unsubscribe().then(function(){t(e)})["catch"](function(){t(e)}):t(e)})["catch"](function(n){t(e)})}),p.autoRegister&&$("html.default #defaultSubscribe").trigger("click")}"chrome"==p.platform&&e(),navigator.serviceWorker.register(p.defaultUrl+p.scope+"sw.js",{scope:p.scope}).then(function(e){p.log("[SW] Registration successful with scope: ",e.scope),a(e),p.log(e),t(e)})["catch"](function(e){p.log("[SW] Registration failed",e)})}function c(){function e(e,t){return new Promise(function(n,o){var a,r;a=setTimeout(function(){a=!1,o({err:"Timed out on loading iframe"})},5e3);var s=new Promise(function(e,n){var o,i,a;a={},i=function(n){var s=n.origin||n.originalEvent.origin;return s!=t?void p.log("Origins doesn't match!!!"):("object"==typeof n.data&&(n.data.hasOwnProperty("permission")&&(p.log("[IC] <= Message from "+n.origin+": permission is "+n.data.permission),a.permission=n.data.permission),n.data.hasOwnProperty("worker")&&(p.log("[IC] <= Message from "+n.origin+": token is "+n.data.worker),a.worker=n.data.worker)),a.iframeWindow=n.source,a.iframeObject=r,void(a.hasOwnProperty("permission")&&a.hasOwnProperty("worker")&&(window.removeEventListener("message",i,!1),o=o===!1||clearTimeout(o),!1,e(a))))},o=setTimeout(function(){o=!1,window.removeEventListener("message",i,!1),a.hasOwnProperty("permission")?e(a):n("Timed out on waiting message")},1e3),window.addEventListener("message",i,!1)});r=i(e,function(e){a=a===!1||clearTimeout(a),!1,n(s)},function(e){a=a===!1||clearTimeout(a),!1,o({err:"Fail to embed iframe",e:e})})})}function t(e,t,n){var o={},i=function(i){var a=i.origin||i.originalEvent.origin;return a!=n?void p.log("Origins doesn't match!!!"):void("object"==typeof i.data&&i.data.message&&i.data.serial&&i.data.result&&o.hasOwnProperty(i.data.serial)&&(p.log("[IC] <= Message from "+i.origin+": "+JSON.stringify(i.data)),o[i.data.serial](e,t,n,i.data.result),delete o[i.data.serial]))};return window.addEventListener("message",i,!1),function(e,a,r){var s;return i===!1?!1:"die"==e?(window.removeEventListener("message",i,!1),i=!1,!0):(s=l(),o[s]=a,r=r||{},r.message=e,r.serial=s,t.postMessage(r,n),!0)}}function o(e,t){return"#check-"+u(JSON.stringify([e,t]))}function i(e,t,n,o){return o=o||document.createElement("iframe"),o.setAttribute("frameborder","0"),o.setAttribute("scrolling","no"),o.setAttribute("sandbox","allow-same-origin allow-scripts allow-top-navigation"),o.setAttribute("style","width: 100%; height: 0px; position: fixed; bottom: 0px; left: 0px; overflow: hidden;box-shadow: 0 -10px 19px rgba(1, 8, 41, 0.07); z-index: 1000;"),o.addEventListener("load",t),o.addEventListener("error",n),o.src=e,document.body.appendChild(o),o}function a(){var e=document.getElementById("TUTBYPush-"+p.appId);e&&"A"==e.nodeName&&(e.setAttribute("href","https://www.tut.by/push/?url="+encodeURIComponent(window.location.href.toString())),e.innerText="Настройка уведомлений")}var r,s;p.log("Start page workflow"),r=p.defaultUrl+p.scope+o(p.platform,window.location.origin),s=r.replace(/^(https:\/\/[^\/]+)\/.*$/,"$1"),p.dbh.get("closedAt").then(function(o){e(r,s).then(function(e){var i=new n(p.dbh);i.manageToken(e.permission,e.worker).then(function(){var n,i,r=(new Date).valueOf();switch(e.permission){case"granted":e.iframeObject.remove(),a();break;case"default":o=parseInt(o,10),i=isNaN(o)||r-o>864e5*p.notify_days_limit,i=i&&(r<=new Date(2016,3,5).valueOf()||r>=new Date(2016,3,11).valueOf()),i?(n=t(e.iframeObject,e.iframeWindow,s,{}),n("close",function(e,t,n,o){function i(){e.remove()}p.dbh.put("closedAt",(new Date).valueOf()).then(i,i)}),n("welcome",function(e,t,n,o){window.jQuery?$(e).animate({height:o+"px"},750):e.style.height=o+"px"},{url:window.location.toString()})):e.iframeObject.remove(),a();break;case"denied":e.iframeObject.remove()}})["catch"](function(t){p.log(t),e.iframeObject.remove()})})["catch"](function(e){p.log("Iframe error",e)})})["catch"](function(e){p.log(e)})}function u(e){return window.btoa(escape(encodeURIComponent(e)))}function d(e){return decodeURIComponent(unescape(window.atob(e)))}function l(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function f(e,t){return new Promise(function(n,o){var i=new XMLHttpRequest;i.onreadystatechange=function(){4==i.readyState&&(200<=i.status&&i.status<=299?n(i):o(i))},i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(t))})}function h(e){return new Promise(function(t,n){var o=new MessageChannel;o.port1.onmessage=function(e){t(e.data)};try{navigator.serviceWorker.controller.postMessage(e,[o.port2])}catch(i){n(i)}})}e.prototype=function(){function e(e,t,n){e.onsuccess=function(e){t(e.target.result?e.target.result.value:void 0)},e.onerror=function(e){n(e)}}return{init:function(){var e=this;return new Promise(function(t,n){var o=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,i=o.open(e.name,e.version);i.onsuccess=function(e){t(e.target.result)},i.onerror=function(e){n(e)},i.onupgradeneeded=function(t){t.target.result.createObjectStore(e.table,{keyPath:"name"})}})},get:function(t){var n=this;return new Promise(function(o,i){n.init().then(function(i){o(new Promise(function(o,a){e(i.transaction([n.table],"readonly").objectStore(n.table).get(t),o,a)}))})["catch"](function(e){i(e)})})},put:function(t,n){var o=this;return new Promise(function(i,a){o.init().then(function(a){i(new Promise(function(i,r){e(a.transaction([o.table],"readwrite").objectStore(o.table).put({name:t,value:n}),i,r)}))})["catch"](function(e){a(e)})})},"delete":function(t,n,o){var i=this;return new Promise(function(n,o){i.init().then(function(o){n(new Promise(function(n,a){e(o.transaction([i.table],"readwrite").objectStore(i.table)["delete"](t),n,a)}))})["catch"](function(e){o(e)})})}}}(),t.prototype.init=function(t){var n=i(window.location.hash);return t=t||{},this.log(navigator.userAgent),this.debug=!!t.debug,this.autoRegister=!!t.autoRegister,this.platform=n?n[0]:a(n),this.targetOrigin=n?n[1]:!1,this.appId=t.appId||"fe8daf4c-ea96-11e5-8de3-00215ae090fb",this.defaultUrl=t.defaultUrl||"https://www.tut.by"||window.location.origin,this.path=t.path||"/push/"||"/",this.scope=t.scope||this.path+this.appId+"/",this.gcm_sender_id=t.gcm_sender_id||"837219378249"||!1,this.apn_id=t.apn_id||"web.by.tut.push"||!1,this.notify_days_limit=parseInt(t.notify_days_limit,10)||7,this.return_url=t.return_url||!1,this.log("Push notifications platform: "+this.platform),this.https="https:"==window.location.protocol,this.platform?this.gcm_sender_id||"chrome"!=this.platform?(this.dbh=new e("TUTBYPush-"+this.appId,1),window.addEventListener("load",function(){var e,t=this;t.defaultUrl==window.location.origin&&window.top===window?(t.return_url||(e=window.location.search.match(/[?&]url=([^&#]+)/))&&e&&(e=decodeURIComponent(e[1]).match(/^(https?:\/\/.+)$/))&&e&&(t.return_url=e[1]),"safari"==t.platform?r():s()):window.top!==window&&t.targetOrigin?("safari"!=t.platform&&h({hash:n,scope:t.scope}).then(function(e){window.top.postMessage({worker:e},t.targetOrigin)})["catch"](function(e){t.log(e)}),window.addEventListener("message",function(e){if(e.origin==n[1]&&"object"==typeof e.data&&e.data.hasOwnProperty("message")&&e.data.hasOwnProperty("serial"))switch(t.log("[IC] => Message from "+e.origin+": "+JSON.stringify(e.data)),e.data.message){case"welcome":$("html").attr("class","welcome"),e.data&&e.data.url&&(t.return_url=e.data.url,$("#welcomeLink").attr("href","https://www.tut.by/push/?url="+encodeURIComponent(t.return_url))),e.source.postMessage({message:e.data.message,serial:e.data.serial,result:window.document.body.clientHeight},e.origin);break;case"close":$("#welcomeClose").on("click",function(t){return t.preventDefault(),e.source.postMessage({message:e.data.message,serial:e.data.serial,result:!0},e.origin),!1})}},!1)):c()}.bind(this)),window.top!==window&&this.targetOrigin&&window.top.postMessage({permission:Notification.permission},this.targetOrigin),!0):(this.log("Push notifications platform is "+this.platform+" but GCM is not set"),!1):(this.defaultUrl==window.location.origin&&window.top===window&&(document.getElementsByTagName("html")[0].className="unsupported"),!1)},t.prototype.log=function(e){this.debug&&console&&console.log&&(console.group(window.location.origin),console.log.apply(console,arguments),console.groupEnd())},n.prototype.getToken=function(){return new Promise(function(e,t){p.dbh.get("token").then(e)["catch"](t)})},n.prototype.setToken=function(e){return new Promise(function(t,n){p.dbh.put("token",e).then(t)["catch"](n)})},n.prototype.removeToken=function(){return new Promise(function(e,t){p.dbh["delete"]("token").then(e)["catch"](t)})},n.prototype.endPoint=function(e){return p.defaultUrl+p.scope+e},n.prototype.data=function(e){return{platform:p.platform,token:e}},n.prototype.manageToken=function(e,t){var n=this;return t={token:t,tm:(new Date).valueOf()},new Promise(function(o,i){n.getToken().then(function(a){if(a&&a.token)switch(e){case"granted":t.token?t.token==a.token?t.tm-a.tm>6048e5?f(n.endPoint("subscribe"),n.data(t.token)).then(function(e){n.setToken(t).then(o)["catch"](i)})["catch"](i):o():f(n.endPoint("subscribe"),n.data([t.token,a.token])).then(function(e){n.setToken(t).then(o)["catch"](i)})["catch"](i):f(n.endPoint("unsubscribe"),n.data(a.token)).then(function(e){n.removeToken().then(o)["catch"](i)})["catch"](i);break;case"default":case"denied":default:f(n.endPoint("unsubscribe"),n.data(a.token)).then(function(e){n.removeToken().then(o)["catch"](i)})["catch"](i)}else if(t.token)switch(e){case"granted":f(n.endPoint("subscribe"),n.data(t.token)).then(function(e){n.setToken(t).then(o)["catch"](i)})["catch"](i);break;case"default":case"denied":default:o()}else o()})["catch"](i)})};var p=new t;return p}();